# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy-server-1:
    name: Deploy to Server 1
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: Install dependencies
        run: |
          npm ci

      - name: Configure environment variables
        run: |
          echo "NEXT_PUBLIC_HOSTNAME=$HOSTNAME" >> .env
          echo "NEXT_PUBLIC_SERVERNAME=$SERVERNAME" >> .env
        env:
          HOSTNAME: ${{ secrets.SERVER1_HOSTNAME }}
          SERVERNAME: ${{ secrets.SERVER1_SERVERNAME }}

      - name: Build
        run: |
          npm run build

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SERVER1_SSH_KEY }}

      - name: Add server 1 host key
        run: ssh-keyscan server1.kweeksnews.com >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          cd ${{ github.workspace }}/dist
          git config --global user.email "admin@kweeksnews.com"
          git config --global user.name "KweeksDev"
          git init
          git add .
          git commit -m "${{ github.event.head_commit.message }}"
          git push -u ssh://kweeksne@server1.kweeksnews.com/home/kweeksne/public_html0 main:main -f
